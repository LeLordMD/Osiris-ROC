<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Osiris - ROC</title>
  <style>
    :root{
      --red:#c62828;
      --red-delivered:#d42b2b;
      --bg:#f3f4f6;
      --card:#ffffff;
      --btn-border:rgba(0,0,0,0.06);
      --shadow:rgba(16,24,40,0.06);
      --text:#0b1020;
      --green-light:#d9f2d9;
      --green-strong:#2ca14b;
      --yellow:#f2c94c;
      --radius:12px;
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    }

    html,body{height:100%;margin:0;}
    body{
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      display:flex;
      flex-direction:column;
      min-height:100%;
      font-size:15px;
    }

    .topbar{
      background:var(--red);
      padding:18px 20px;
      display:flex;
      align-items:center;
      gap:14px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
    }
    .topbar .back{
      width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;background:rgba(255,255,255,0.12);cursor:pointer;color:#fff;font-weight:800;user-select:none;
      font-size:1.15rem;
    }
    .topbar .title{
      flex:1;text-align:center;font-weight:900;font-size:2.2rem;color:#fff;margin-right:44px;
    }

    main{ flex:1; padding:28px; max-width:1200px; width:100%; margin:0 auto; box-sizing:border-box; }

    .grid-main{ display:flex; flex-direction:column; gap:14px; margin-top:8px; }
    .grid-btn{
      background:var(--card);
      border-radius:16px;
      padding:24px 22px;
      text-align:center;
      font-weight:900;
      font-size:1.7rem;
      color:var(--text);
      cursor:pointer;
      box-shadow:0 10px 28px rgba(16,24,40,0.06);
      text-decoration:none;
      display:block;
      transition: transform .12s cubic-bezier(.2,.9,.2,1), box-shadow .12s cubic-bezier(.2,.9,.2,1);
      min-height:80px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .grid-btn .desc{ display:none; }

    .grid-btn:hover{
      transform: translateY(-8px);
      box-shadow: 0 26px 50px rgba(16,24,40,0.14);
    }

    .submenu{ display:flex; flex-direction:column; gap:20px; }
    .subtitle{ font-size:1.35rem; font-weight:800; color:var(--text); margin:8px 0; }

    .section-title{ font-size:1.1rem; font-weight:900; color:#9b1e1e; margin:10px 0; }

    .btn-grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(210px,1fr)); gap:14px; margin-bottom:18px; }

    .small-btn{
      background:var(--green-light);
      border:1px solid var(--btn-border);
      border-radius:12px;
      padding:16px;
      font-weight:900;
      color:#000;
      cursor:pointer;
      text-align:center;
      box-shadow:0 8px 20px rgba(0,0,0,0.04);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      min-height:100px;
      transition: transform .12s cubic-bezier(.2,.9,.2,1), box-shadow .12s cubic-bezier(.2,.9,.2,1);
      position:relative;
    }
    .small-btn:hover{
      transform: translateY(-6px);
      box-shadow: 0 22px 44px rgba(16,24,40,0.12);
    }

    .small-btn > div:first-child{
      font-size:1.4rem;
      font-weight:900;
      line-height:1;
    }

    .meta-vertical{ color:#43494d; font-weight:700; font-size:0.95rem; display:flex; flex-direction:column; gap:6px; align-items:center; text-align:center; }

    .state-default{ background:var(--green-light); color:#000; }
    .state-delivered{ background:var(--red-delivered); color:#fff; }
    .state-gonflage{ background:var(--yellow); color:#000; }
    .state-disponible{ background:var(--green-light); color:#000; }
    .state-hs{ background:#000; color:#fff; }

    /* surveillance badge (triangle with exclamation) */
    .surv-badge {
      width:22px; height:22px;
      display:inline-flex; align-items:center; justify-content:center;
      background:#ff4d4f; color:#fff; font-weight:900; border-radius:4px;
      clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
      font-size:14px;
      position:absolute;
      bottom:8px;
      right:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.12);
    }
    .surv-badge span{ transform:translateY(-2px); }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(8,10,12,0.45); display:none; align-items:center; justify-content:center; z-index:60; }
    .panel{ background:#fff; border-radius:12px; width:min(760px,96%); max-height:92vh; overflow:auto; padding:22px; box-shadow:0 18px 60px rgba(2,6,23,0.4); position:relative; }
    .panel h2{ margin:0 0 12px 0; font-size:1.5rem; }

    .hs-btn {
      position:absolute;
      top:12px;
      right:12px;
      background:#000;
      color:#fff;
      border:0;
      padding:8px 12px;
      border-radius:8px;
      font-weight:800;
      cursor:pointer;
      z-index:5;
    }

    .field{ margin:12px 0; display:flex; gap:14px; align-items:center; }
    .field label{ min-width:150px; font-weight:800; color:#223; font-size:1rem; }
    .field input[type="text"], .field input[type="number"]{ padding:10px; border:1px solid #d8dde6; border-radius:10px; flex:1; font-size:1rem; text-transform:uppercase; }

    /* surveillance specific: text input normal-case except first letter capitalized */
    .field .surv-input{ text-transform:none; }

    .surv-controls{ display:flex; gap:8px; align-items:center; }

    .delete-surv { background:transparent; border:0; color:var(--red); font-weight:800; cursor:pointer; font-size:1.1rem; padding:6px; border-radius:6px; }

    .press-gd { display:flex; gap:8px; width:100%; }
    .press-gd input { flex:1; text-transform:none; } /* numeric, no uppercase transformation visually */

    .panel-footer{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:18px; }
    .actions-left{ display:flex; gap:12px; align-items:center; }
    .actions-right{ display:flex; gap:12px; align-items:center; }

    .btn{ padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:800; min-width:140px; font-size:1rem; }
    .btn.ghost{ background:#f3f6fb; color:var(--red); border:1px solid #e6edf9; }
    .btn.red{ background:var(--red-delivered); color:#fff; }
    .btn.yellow{ background:var(--yellow); color:#000; }
    .btn.green{ background:var(--green-strong); color:#fff; }

    .hidden{ display:none !important; }

    @media (max-width:900px){
      .topbar .title{ font-size:1.8rem; }
      .panel{ width:min(92%,720px); }
      .small-btn > div:first-child{ font-size:1.2rem; }
      .grid-btn{ font-size:1.4rem; padding:16px; }
    }
    @media (max-width:640px){
      .btn-grid{ grid-template-columns: repeat(2,1fr); }
      .field label{ min-width:110px; }
      .panel-footer{ flex-direction:column-reverse; align-items:stretch; }
      .topbar .title{ font-size:1.4rem; margin-right:36px; }
      .grid-btn{ font-size:1.2rem; padding:12px; }
      .small-btn{ min-height:88px; padding:12px; }
      .small-btn > div:first-child{ font-size:1.05rem; }
      .hs-btn{ top:8px; right:8px; padding:6px 10px; }
      .surv-badge{ width:18px; height:18px; font-size:12px; bottom:6px; right:6px; }
    }
  </style>
</head>
<body>
  <div class="topbar" role="banner">
    <div class="back hidden" id="backBtn" aria-hidden="true" title="Retour">←</div>
    <div class="title">Osiris - ROC</div>
  </div>

  <main>
    <div id="home" class="home">
      <div class="grid-main">
        <a class="grid-btn" id="openCadresMain" href="#" role="button">Synoptique des Cadres et Biolines</a>
        <a class="grid-btn" id="openEnginsMain" href="#" role="button">Synoptique des Engins</a>
        <a class="grid-btn" id="openArchivesMain" href="#" role="button">Interventions archivées</a>
      </div>
    </div>

    <section id="cadresView" class="submenu hidden" aria-label="Synoptique des Cadres et Biolines">
      <div class="subtitle">Synoptique des Cadres et Biolines</div>

      <div class="section">
        <div class="section-title">Cadres d'air</div>
        <div id="cadresGrid" class="btn-grid" aria-label="Liste des cadres"></div>
      </div>

      <div class="section">
        <div class="section-title">Biolines</div>
        <div id="biolinesGrid" class="btn-grid" aria-label="Liste des biolines"></div>
      </div>
    </section>

    <section id="enginsView" class="submenu hidden" aria-label="Synoptique des Engins">
      <div class="subtitle">Synoptique des Engins</div>
      <div style="color:#55606b;">Contenu Synoptique des Engins — à implémenter ou brancher sur vos données existantes.</div>
    </section>

    <section id="archivesView" class="submenu hidden" aria-label="Interventions archivées">
      <div class="subtitle">Interventions archivées</div>
      <div style="color:#55606b;">Contenu Interventions archivées — à implémenter ou brancher sur vos sources.</div>
    </section>
  </main>

  <div class="modal-backdrop" id="modal" role="dialog" aria-hidden="true">
    <div class="panel" role="document" aria-labelledby="panelTitle">
      <button id="hsBtn" class="hs-btn hidden" title="Mettre Hors Service">Hors Service</button>

      <h2 id="panelTitle">Objet n°X</h2>

      <div class="field">
        <label>Localisation :</label>
        <input id="localisationInput" type="text" placeholder="ex: CT, Garage, VPCE / CT..." />
      </div>

      <div id="pressionCadreField" class="field">
        <label>Pression :</label>
        <input id="pressionInput" type="number" inputmode="numeric" pattern="[0-9]*" min="0" placeholder="ex: 300" />
      </div>

      <div id="pressionBiolineField" class="field hidden">
        <label>Pressions G / D :</label>
        <div class="press-gd">
          <input id="pressionG" type="number" inputmode="numeric" pattern="[0-9]*" min="0" placeholder="G" />
          <input id="pressionD" type="number" inputmode="numeric" pattern="[0-9]*" min="0" placeholder="D" />
        </div>
      </div>

      <div class="field">
        <label>Surveillance :</label>
        <div class="surv-controls" style="flex:1;">
          <input id="survInput" class="surv-input" type="text" placeholder="Remarque de surveillance..." />
          <button id="clearSurvBtn" class="delete-surv" title="Supprimer la surveillance">✕</button>
        </div>
      </div>

      <div class="panel-footer">
        <div class="actions-left">
          <button id="actionBtn" class="btn yellow">Gonflage</button>
        </div>
        <div class="actions-right">
          <button id="validerBtn" class="btn ghost">Valider</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, set, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCehIP1O3ZsFsdOt-zjMI0Zex2HazNjKKU",
      authDomain: "osiris-roc-1-0.firebaseapp.com",
      databaseURL: "https://osiris-roc-1-0-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "osiris-roc-1-0",
      storageBucket: "osiris-roc-1-0.firebasestorage.app",
      messagingSenderId: "794382198691",
      appId: "1:794382198691:web:374f549533dbaa1fc79c16"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // UI refs
    const home = document.getElementById('home');
    const backBtn = document.getElementById('backBtn');
    const openCadresMain = document.getElementById('openCadresMain');
    const openEnginsMain = document.getElementById('openEnginsMain');
    const openArchivesMain = document.getElementById('openArchivesMain');
    const cadresView = document.getElementById('cadresView');
    const enginsView = document.getElementById('enginsView');
    const archivesView = document.getElementById('archivesView');
    const cadresGrid = document.getElementById('cadresGrid');
    const biolinesGrid = document.getElementById('biolinesGrid');

    const modal = document.getElementById('modal');
    const panelTitle = document.getElementById('panelTitle');
    const localisationInput = document.getElementById('localisationInput');
    const pressionInput = document.getElementById('pressionInput');
    const pressionBiolineField = document.getElementById('pressionBiolineField');
    const pressionCadreField = document.getElementById('pressionCadreField');
    const pressionG = document.getElementById('pressionG');
    const pressionD = document.getElementById('pressionD');
    const actionBtn = document.getElementById('actionBtn');
    const validerBtn = document.getElementById('validerBtn');
    const hsBtn = document.getElementById('hsBtn');
    const survInput = document.getElementById('survInput');
    const clearSurvBtn = document.getElementById('clearSurvBtn');

    // Local store
    const store = { cadres: {}, biolines: {} };

    function showView(viewEl) {
      home.classList.add('hidden');
      [cadresView, enginsView, archivesView].forEach(s => s.classList.add('hidden'));
      viewEl.classList.remove('hidden');
      backBtn.classList.remove('hidden');
    }
    function showHome() {
      [cadresView, enginsView, archivesView].forEach(s => s.classList.add('hidden'));
      home.classList.remove('hidden');
      backBtn.classList.add('hidden');
    }

    openCadresMain.addEventListener('click', (e)=>{ e.preventDefault(); showView(cadresView); });
    openEnginsMain.addEventListener('click', (e)=>{ e.preventDefault(); showView(enginsView); });
    openArchivesMain.addEventListener('click', (e)=>{ e.preventDefault(); showView(archivesView); });
    backBtn.addEventListener('click', (e)=>{ e.preventDefault(); showHome(); });

    function cadrePath(n){ return `Cadre/${n}`; }
    function biolinePath(n){ return `Bioline/${n}`; }

    // Helper to return default pressure value when setting Disponible for a bioline index
    function defaultBiolinePressureForIndex(idx){
      return (idx === 3 || idx === 5) ? '200' : '300';
    }

    // Ensure nodes exist and set bioline default Pression for #3 and #5 to 200
    async function ensureNodes(){
      for(let i=1;i<=10;i++){
        const snap = await get(ref(db, cadrePath(i)));
        if (!snap.exists()){
          await set(ref(db, cadrePath(i)), { Localisation: '', Pression: '', State: 'default', Surveillance: '' });
        } else {
          const v = snap.val() || {};
          if (v.Surveillance === undefined) await update(ref(db, cadrePath(i)), { Surveillance: '' });
          if (v.Pression === undefined) await update(ref(db, cadrePath(i)), { Pression: '' });
        }
      }
      for(let i=1;i<=5;i++){
        const snap = await get(ref(db, biolinePath(i)));
        if (!snap.exists()){
          const defaultPress = (i===3 || i===5) ? { G: '200', D: '200' } : { G: '', D: '' };
          await set(ref(db, biolinePath(i)), { Localisation: '', Pression: defaultPress, State: 'default', Surveillance: '' });
        } else {
          const v = snap.val() || {};
          if (v.Surveillance === undefined) await update(ref(db, biolinePath(i)), { Surveillance: '' });
          if (v.Pression === undefined) {
            const defaultPress = (i===3 || i===5) ? { G: '200', D: '200' } : { G: '', D: '' };
            await update(ref(db, biolinePath(i)), { Pression: defaultPress });
          } else {
            if (typeof v.Pression === 'string' || typeof v.Pression === 'number') {
              const val = String(v.Pression || '');
              const defaultPress = (i===3 || i===5) ? { G: '200', D: '200' } : { G: val, D: val };
              await update(ref(db, biolinePath(i)), { Pression: defaultPress });
            } else {
              const g = v.Pression.G ?? ((i===3||i===5)? '200' : '');
              const d = v.Pression.D ?? ((i===3||i===5)? '200' : '');
              await update(ref(db, biolinePath(i)), { Pression: { G: g, D: d } });
            }
          }
        }
      }
    }
    ensureNodes().catch(console.error);

    // Build UI
    for(let i=1;i<=10;i++){
      store.cadres[i] = { Localisation:'', Pression:'', State:'default', Surveillance: '' };
      const btn = document.createElement('button');
      btn.className = 'small-btn state-default';
      btn.id = `cadre-${i}`;
      btn.innerHTML = `<div>Cadre n°${i}</div><div class="meta-vertical" id="meta-cadre-${i}"></div>`;
      btn.dataset.idx = i;
      btn.addEventListener('click', ()=> openPanel('Cadre', i));
      cadresGrid.appendChild(btn);
    }

    for(let i=1;i<=5;i++){
      store.biolines[i] = { Localisation:'', Pression:{G:'',D:''}, State:'default', Surveillance: '' };
      const btn = document.createElement('button');
      btn.className = 'small-btn state-default';
      btn.id = `bioline-${i}`;
      btn.innerHTML = `<div>Bioline n°${i}</div><div class="meta-vertical" id="meta-bioline-${i}"></div>`;
      btn.dataset.idx = i;
      btn.addEventListener('click', ()=> openPanel('Bioline', i));
      biolinesGrid.appendChild(btn);
    }

    // Realtime listeners
    for(let i=1;i<=10;i++){
      const r = ref(db, `Cadre/${i}`);
      onValue(r, (snap) => {
        const v = snap.val() || {};
        store.cadres[i].Localisation = v.Localisation ?? '';
        store.cadres[i].Pression = v.Pression ?? '';
        store.cadres[i].State = v.State ?? (store.cadres[i].State || 'default');
        store.cadres[i].Surveillance = v.Surveillance ?? '';
        refreshCadreUI(i);
        if (activeType === 'Cadre' && activeIdx === i) refreshActionButton();
      });
    }

    for(let i=1;i<=5;i++){
      const r = ref(db, `Bioline/${i}`);
      onValue(r, (snap) => {
        const v = snap.val() || {};
        store.biolines[i].Localisation = v.Localisation ?? '';
        if (v.Pression && typeof v.Pression === 'object') {
          store.biolines[i].Pression = { G: String(v.Pression.G ?? ''), D: String(v.Pression.D ?? '') };
        } else {
          const p = String(v.Pression ?? '');
          store.biolines[i].Pression = { G: p, D: p };
        }
        store.biolines[i].State = v.State ?? (store.biolines[i].State || 'default');
        store.biolines[i].Surveillance = v.Surveillance ?? '';
        refreshBiolineUI(i);
        if (activeType === 'Bioline' && activeIdx === i) refreshActionButton();
      });
    }

    // UI refresh functions
    function refreshCadreUI(i){
      const d = store.cadres[i];
      const btn = document.getElementById(`cadre-${i}`);
      const meta = document.getElementById(`meta-cadre-${i}`);
      if (d.State === 'disponible' || d.State === 'default') {
        meta.innerHTML = '';
      } else {
        const lines = [];
        if (d.Localisation) lines.push(`Localisation: ${d.Localisation}`);
        if (d.Pression) lines.push(`Pression: ${d.Pression}`);
        meta.innerHTML = lines.map(l=>`<div>${l}</div>`).join('');
      }
      btn.classList.remove('state-default','state-delivered','state-gonflage','state-disponible','state-hs');
      const existingBadge = btn.querySelector('.surv-badge');
      if (existingBadge) existingBadge.remove();
      if (d.State === 'delivered') btn.classList.add('state-delivered');
      else if (d.State === 'gonflage') btn.classList.add('state-gonflage');
      else if (d.State === 'disponible') btn.classList.add('state-disponible');
      else if (d.State === 'HS') btn.classList.add('state-hs');
      else btn.classList.add('state-default');
      if (d.Surveillance && d.Surveillance.trim() !== '') {
        const badge = document.createElement('div');
        badge.className = 'surv-badge';
        badge.innerHTML = `<span>!</span>`;
        btn.appendChild(badge);
      }
    }

    function refreshBiolineUI(i){
      const d = store.biolines[i];
      const btn = document.getElementById(`bioline-${i}`);
      const meta = document.getElementById(`meta-bioline-${i}`);
      if (d.State === 'disponible' || d.State === 'default') {
        meta.innerHTML = '';
      } else {
        const lines = [];
        if (d.Localisation) lines.push(`Localisation: ${d.Localisation}`);
        const g = d.Pression && d.Pression.G ? d.Pression.G : '';
        const dd = d.Pression && d.Pression.D ? d.Pression.D : '';
        if (g || dd) lines.push(`Pression G: ${g} ; D: ${dd}`);
        meta.innerHTML = lines.map(l=>`<div>${l}</div>`).join('');
      }
      btn.classList.remove('state-default','state-delivered','state-gonflage','state-disponible','state-hs');
      const existingBadge = btn.querySelector('.surv-badge');
      if (existingBadge) existingBadge.remove();
      if (d.State === 'delivered') btn.classList.add('state-delivered');
      else if (d.State === 'gonflage') btn.classList.add('state-gonflage');
      else if (d.State === 'disponible') btn.classList.add('state-disponible');
      else if (d.State === 'HS') btn.classList.add('state-hs');
      else btn.classList.add('state-default');
      if (d.Surveillance && d.Surveillance.trim() !== '') {
        const badge = document.createElement('div');
        badge.className = 'surv-badge';
        badge.innerHTML = `<span>!</span>`;
        btn.appendChild(badge);
      }
    }

    // Modal state
    let activeType = null;
    let activeIdx = null;

    // temp restore variables
    let tempPrevLocalisation = null;
    let tempPrevPression = null;
    let tempPrevPressionG = null;
    let tempPrevPressionD = null;
    let hasClearedLocalisation = false;
    let hasClearedPression = false;
    let hasClearedPressionG = false;
    let hasClearedPressionD = false;

    function openPanel(type, idx){
      activeType = type;
      activeIdx = idx;
      const d = (type === 'Cadre') ? store.cadres[idx] : store.biolines[idx];
      panelTitle.textContent = `${type} n°${idx}`;

      localisationInput.value = (d.Localisation || '').toString().toUpperCase();

      if (type === 'Bioline') {
        pressionCadreField.classList.add('hidden');
        pressionBiolineField.classList.remove('hidden');
        pressionG.value = (d.Pression && d.Pression.G) ? d.Pression.G : '';
        pressionD.value = (d.Pression && d.Pression.D) ? d.Pression.D : '';
        tempPrevPressionG = pressionG.value;
        tempPrevPressionD = pressionD.value;
        hasClearedPressionG = false;
        hasClearedPressionD = false;
      } else {
        pressionBiolineField.classList.add('hidden');
        pressionCadreField.classList.remove('hidden');
        pressionInput.value = d.Pression || '';
        tempPrevPression = pressionInput.value;
        hasClearedPression = false;
      }

      survInput.value = formatSurveillanceForInput(d.Surveillance || '');

      tempPrevLocalisation = localisationInput.value;
      hasClearedLocalisation = false;

      refreshActionButton();
      hsBtn.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      setTimeout(()=> {
        if (type === 'Bioline') pressionG.focus();
        else pressionInput.focus();
      },50);
    }

    function closePanel(){
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      activeType = null;
      activeIdx = null;
      tempPrevLocalisation = null;
      tempPrevPression = null;
      tempPrevPressionG = null;
      tempPrevPressionD = null;
      hasClearedLocalisation = false;
      hasClearedPression = false;
      hasClearedPressionG = false;
      hasClearedPressionD = false;
      hsBtn.classList.add('hidden');
    }

    function debounce(fn, wait=300){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

    const liveWrite = debounce(async (type, idx, field, value) => {
      try {
        const path = (type === 'Cadre') ? `Cadre/${idx}` : `Bioline/${idx}`;
        const obj = {}; obj[field] = value;
        await update(ref(db, path), obj);
      } catch(err){ console.error('liveWrite', err); }
    }, 300);

    // HS button click
    hsBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!activeType || !activeIdx) return;
      const type = activeType;
      const idx = activeIdx;
      const path = (type === 'Cadre') ? `Cadre/${idx}` : `Bioline/${idx}`;
      closePanel();
      try {
        if (type === 'Bioline') {
          await update(ref(db, path), { State: 'HS', Localisation: 'HS', Pression: { G: '0', D: '0' } });
        } else {
          await update(ref(db, path), { State: 'HS', Localisation: 'HS', Pression: '0' });
        }
      } catch(err){ console.error('hsBtn', err); }
    });

    // Localisation handlers
    localisationInput.addEventListener('focus', (e) => {
      if (!activeType || !activeIdx) return;
      if (!hasClearedLocalisation) {
        tempPrevLocalisation = localisationInput.value;
        localisationInput.value = '';
        hasClearedLocalisation = true;
      }
    });
    localisationInput.addEventListener('blur', (e) => {
      if (!activeType || !activeIdx) return;
      const v = (e.target.value || '').trim();
      if (v === '' && tempPrevLocalisation !== null) {
        localisationInput.value = tempPrevLocalisation;
        hasClearedLocalisation = false;
      }
    });
    localisationInput.addEventListener('input', (e) => {
      if (!activeType || !activeIdx) return;
      const raw = e.target.value || '';
      const v = raw.toUpperCase();
      if (e.target.value !== v) e.target.value = v;
      if (activeType === 'Cadre') store.cadres[activeIdx].Localisation = v;
      else store.biolines[activeIdx].Localisation = v;
      liveWrite(activeType, activeIdx, 'Localisation', v);
    });

    // Pression (cadre) handlers
    pressionInput.addEventListener('focus', (e) => {
      if (!activeType || !activeIdx) return;
      if (!hasClearedPression) {
        tempPrevPression = pressionInput.value;
        pressionInput.value = '';
        hasClearedPression = true;
      }
    });
    pressionInput.addEventListener('blur', (e) => {
      if (!activeType || !activeIdx) return;
      const v = (e.target.value || '').trim();
      if (v === '' && tempPrevPression !== null) {
        pressionInput.value = tempPrevPression;
        hasClearedPression = false;
      }
    });
    pressionInput.addEventListener('input', (e) => {
      if (!activeType || !activeIdx) return;
      const v = e.target.value;
      if (activeType === 'Cadre') store.cadres[activeIdx].Pression = v;
      liveWrite('Cadre', activeIdx, 'Pression', v);
    });

    // Pression G/D (bioline) handlers
    pressionG.addEventListener('focus', (e) => {
      if (!activeType || !activeIdx) return;
      if (!hasClearedPressionG) {
        tempPrevPressionG = pressionG.value;
        pressionG.value = '';
        hasClearedPressionG = true;
      }
    });
    pressionG.addEventListener('blur', (e) => {
      if (!activeType || !activeIdx) return;
      const v = (e.target.value || '').trim();
      if (v === '' && tempPrevPressionG !== null) {
        pressionG.value = tempPrevPressionG;
        hasClearedPressionG = false;
      }
    });
    pressionG.addEventListener('input', (e) => {
      if (!activeType || !activeIdx) return;
      const v = e.target.value;
      if (activeType === 'Bioline') store.biolines[activeIdx].Pression.G = v;
      const pressObj = { G: String(pressionG.value || ''), D: String(pressionD.value || '') };
      liveWrite('Bioline', activeIdx, 'Pression', pressObj);
    });

    pressionD.addEventListener('focus', (e) => {
      if (!activeType || !activeIdx) return;
      if (!hasClearedPressionD) {
        tempPrevPressionD = pressionD.value;
        pressionD.value = '';
        hasClearedPressionD = true;
      }
    });
    pressionD.addEventListener('blur', (e) => {
      if (!activeType || !activeIdx) return;
      const v = (e.target.value || '').trim();
      if (v === '' && tempPrevPressionD !== null) {
        pressionD.value = tempPrevPressionD;
        hasClearedPressionD = false;
      }
    });
    pressionD.addEventListener('input', (e) => {
      if (!activeType || !activeIdx) return;
      const v = e.target.value;
      if (activeType === 'Bioline') store.biolines[activeIdx].Pression.D = v;
      const pressObj = { G: String(pressionG.value || ''), D: String(pressionD.value || '') };
      liveWrite('Bioline', activeIdx, 'Pression', pressObj);
    });

    // Surveillance helpers
    function formatSurveillanceForInput(s){
      if (!s) return '';
      const trim = s.trim();
      if (trim === '') return '';
      return trim.charAt(0).toUpperCase() + trim.slice(1);
    }
    function normalizeSurveillanceForStore(s){
      if (!s) return '';
      return s.trim();
    }

    survInput.addEventListener('input', (e) => {
      if (!activeType || !activeIdx) return;
      const raw = e.target.value || '';
      const display = raw.length > 0 ? raw.charAt(0).toUpperCase() + raw.slice(1) : '';
      if (e.target.value !== display) e.target.value = display;
      const v = normalizeSurveillanceForStore(display);
      if (activeType === 'Cadre') store.cadres[activeIdx].Surveillance = v;
      else store.biolines[activeIdx].Surveillance = v;
      liveWrite(activeType, activeIdx, 'Surveillance', v);
    });

    // Clear surveillance
    clearSurvBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!activeType || !activeIdx) return;
      const path = (activeType === 'Cadre') ? `Cadre/${activeIdx}` : `Bioline/${activeIdx}`;
      survInput.value = '';
      try { await update(ref(db, path), { Surveillance: '' }); } catch(err){ console.error('clearSurv', err); }
    });

    // Valider: write fields and close modal; restore if empty
    validerBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!activeType || !activeIdx) return;
      const type = activeType;
      const idx = activeIdx;
      const path = (type === 'Cadre') ? `Cadre/${idx}` : `Bioline/${idx}`;

      let Localisation = (localisationInput.value || '').trim().toUpperCase();
      if (Localisation === '' && tempPrevLocalisation !== null) Localisation = tempPrevLocalisation;

      if (type === 'Cadre') {
        let Pression = (pressionInput.value || '').trim();
        if (Pression === '' && tempPrevPression !== null) Pression = tempPrevPression;
        const Surveillance = normalizeSurveillanceForStore(survInput.value || '');
        try { await update(ref(db, path), { Localisation, Pression, Surveillance }); } catch(err){ console.error('valider', err); }
      } else {
        let G = (pressionG.value || '').trim();
        let D = (pressionD.value || '').trim();
        if (G === '' && tempPrevPressionG !== null) G = tempPrevPressionG;
        if (D === '' && tempPrevPressionD !== null) D = tempPrevPressionD;
        const Surveillance = normalizeSurveillanceForStore(survInput.value || '');
        try { await update(ref(db, path), { Localisation, Pression: { G: String(G), D: String(D) }, Surveillance }); } catch(err){ console.error('valider', err); }
      }

      closePanel();
    });

    // Action button: transitions and set default pressures for biolines 3/5 to 200 when becoming available
    actionBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!activeType || !activeIdx) return;
      const type = activeType;
      const idx = activeIdx;
      const cur = (type === 'Cadre') ? { ...store.cadres[idx] } : { ...store.biolines[idx] };
      closePanel();
      const path = (type === 'Cadre') ? `Cadre/${idx}` : `Bioline/${idx}`;
      try {
        if (cur.State === 'default' || cur.State === 'disponible' || !cur.State) {
          await update(ref(db, path), { State: 'delivered' });
          return;
        }
        if (cur.State === 'delivered') {
          if (type === 'Bioline') {
            const newLoc = 'CT';
            await update(ref(db, path), { State: 'gonflage', Localisation: newLoc });
          } else {
            const newLoc = 'VPCE / CT';
            await update(ref(db, path), { State: 'gonflage', Localisation: newLoc });
          }
          return;
        }
        if (cur.State === 'gonflage') {
          if (type === 'Bioline') {
            const pressureDefault = defaultBiolinePressureForIndex(idx);
            await update(ref(db, path), { State: 'default', Pression: { G: pressureDefault, D: pressureDefault } });
          } else {
            await update(ref(db, path), { State: 'default', Pression: '300' });
          }
          return;
        }
        if (cur.State === 'HS') {
          if (type === 'Bioline') {
            const pressureDefault = defaultBiolinePressureForIndex(idx);
            const newLoc = 'CT';
            await update(ref(db, path), { State: 'default', Pression: { G: pressureDefault, D: pressureDefault }, Localisation: newLoc });
          } else {
            await update(ref(db, path), { State: 'default', Pression: '300', Localisation: 'VPCE / CT' });
          }
          return;
        }
      } catch(err){ console.error('actionBtn', err); }
    });

    // Refresh action button text/color
    function refreshActionButton(){
      if (!activeType || !activeIdx) return;
      const cur = (activeType === 'Cadre') ? store.cadres[activeIdx] : store.biolines[activeIdx];
      actionBtn.className = 'btn';
      if (cur.State === 'HS' || cur.State === 'gonflage') {
        actionBtn.textContent = 'Disponible CT';
        actionBtn.classList.add('green');
      } else if (cur.State === 'delivered') {
        actionBtn.textContent = 'Gonflage';
        actionBtn.classList.add('yellow');
      } else {
        actionBtn.textContent = 'Livraison';
        actionBtn.classList.add('red');
      }
    }

    // Modal close handlers
    modal.addEventListener('click', (e) => { if (e.target === modal) closePanel(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.style.display === 'flex') closePanel(); });

  </script>
</body>
</html>
